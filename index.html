<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prompt Crafter Pro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#f4f6ff;
      --card:#ffffff;
      --text:#121826;
      --muted:#6b7280;
      --brand:#4f46e5;
      --brand-2:#22c55e;
      --brand-3:#0284c7;
      --brand-4:#7c3aed;
      --brand-5:#f97316;
      --brand-6:#10b981;
      --ring:rgba(79,70,229,.25);
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }
    .container{max-width:1000px;margin:32px auto;padding:0 20px}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:18px;}
    .logo{
      width:36px;height:36px;border-radius:10px;
      background: conic-gradient(from 180deg at 50% 50%, #06b6d4, #f59e0b, #ef4444, #06b6d4);
      display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:18px;
    }
    h1{font-size:28px;margin:0}
    .subtitle{color:var(--muted);font-size:14px;margin:6px 0 0}
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:14px;
      box-shadow:0 1px 1px rgba(0,0,0,.02), 0 6px 24px rgba(0,0,0,.04);
      padding:18px 18px;
      margin-bottom:16px;
    }
    .section-title{font-weight:600;margin:2px 0 10px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .section-title i{color:var(--brand)}
    .section-title .actions{display:flex;gap:8px;}
    textarea, .output{
      width:100%;border:1px solid var(--border);border-radius:12px;background:#fff;color:var(--text);
      padding:14px;font-size:14px;outline:none;resize:vertical;min-height:120px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    textarea:focus, .output:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
    .btn{
      user-select:none;display:inline-flex;align-items:center;justify-content:center;
      gap:8px;padding:12px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:600;color:#fff;
      transition:.18s transform ease, .18s opacity ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.convert{background:var(--brand);width:100%;margin:14px 0}
    .btn.convert:disabled{opacity:0.6;cursor:not-allowed;}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn.small{padding:10px 14px;font-size:14px;border-radius:10px}
    .btn.copy{background:#111827}
    .btn.claude{background:#111827}
    .btn.chatgpt{background:var(--brand-3)}
    .btn.gemini{background:var(--brand-4)}
    .btn.perplexity{background:var(--brand-5)}
    .btn.deepseek{background:var(--brand-6)}
    .btn.export{background:var(--brand-2)}
    .btn.history{background:#6b7280}
    .btn.templates{background:#8b5cf6}
    .btn.settings{background:#6b7280}
    .muted{color:var(--muted);font-size:12px;margin-top:10px}
    .howto li{margin:6px 0}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;margin:10px 0 18px;
    }
    .api-box{display:flex;gap:8px;align-items:center;display:none;}
    .api-box.show{display:flex;}
    .api-input{
      width:320px;max-width:60vw;
      border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:13px;outline:none;background:#fff;
    }
    .api-input:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
    .btn.save{background:#10b981}
    .footer{color:var(--muted);font-size:12px;margin:18px 0;text-align:center}
    
    /* Examples */
    .examples{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .example-btn{
      background:#f3f4f6;border:1px solid var(--border);border-radius:8px;
      padding:6px 12px;font-size:12px;cursor:pointer;transition:all 0.2s;
    }
    .example-btn:hover{background:#e5e7eb}
    
    .preset-selector{margin:12px 0}
    .preset-option{
      display:inline-flex;align-items:center;gap:6px;margin-right:12px;
      padding:6px 12px;background:#f3f4f6;border-radius:8px;cursor:pointer;
      font-size:13px;
    }
    .preset-option.active{background:var(--brand);color:white}
    
    .history-panel{display:none;margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
    .history-item{
      background:#f9fafb;padding:8px 12px;margin-bottom:6px;border-radius:8px;
      border-left:3px solid var(--brand);cursor:pointer;font-size:13px;
      display:flex;justify-content:space-between;align-items:center;
    }
    .history-item:hover{background:#f3f4f6}
    
    .tooltip{
      position:relative;display:inline-block;
    }
    .tooltip .tooltiptext{
      visibility:hidden;width:200px;background-color:#111827;color:#fff;
      text-align:center;border-radius:6px;padding:5px;position:absolute;
      z-index:1;bottom:125%;left:50%;margin-left:-100px;font-size:12px;
      opacity:0;transition:opacity 0.3s;
    }
    .tooltip:hover .tooltiptext{visibility:visible;opacity:1}
    
    .stats{font-size:12px;color:var(--muted);margin-top:8px}
    
    .auto-convert{display:flex;align-items:center;gap:8px;margin:10px 0;font-size:13px}
    .auto-convert input{width:16px;height:16px}
    
    .notification{
      position:fixed;bottom:20px;right:20px;background:var(--brand-2);color:white;
      padding:12px 16px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);
      display:none;align-items:center;gap:8px;z-index:1000;
    }
    
    .converted-badge{
      display:inline-flex;align-items:center;gap:4px;
      background:#dcfce7;color:#166534;padding:4px 8px;border-radius:6px;
      font-size:12px;margin-left:8px;
    }
    
    .timer-display{
      font-size:11px;color:var(--muted);margin-left:8px;
      display:inline-flex;align-items:center;gap:2px;
    }
    
    /* Template Library Styles */
    .template-categories{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .template-category{
      background:#f3f4f6;padding:6px 12px;border-radius:20px;font-size:12px;
      cursor:pointer;transition:all 0.2s;
    }
    .template-category.active{background:var(--brand);color:white}
    
    .templates-grid{
      display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
      gap:12px;margin-top:12px;
    }
    
    .template-card{
      background:white;border:1px solid var(--border);border-radius:10px;
      padding:14px;cursor:pointer;transition:all 0.2s;
      display:flex;flex-direction:column;height:100%;
    }
    .template-card:hover{
      transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.08);
      border-color:var(--brand);
    }
    
    .template-icon{
      width:36px;height:36px;border-radius:8px;display:flex;
      align-items:center;justify-content:center;margin-bottom:10px;
      color:white;font-size:16px;
    }
    
    .template-title{font-weight:600;margin-bottom:6px;font-size:14px}
    .template-desc{font-size:12px;color:var(--muted);margin-bottom:10px;flex-grow:1}
    .template-meta{display:flex;justify-content:space-between;font-size:11px;color:var(--muted)}
    
    .template-modal{
      display:none;position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.5);z-index:3000;align-items:center;justify-content:center;
      padding:20px;
    }
    
    .template-modal-content{
      background:white;border-radius:14px;width:100%;max-width:600px;
      max-height:90vh;overflow-y:auto;position:relative;
    }
    
    .template-modal-header{
      padding:20px;border-bottom:1px solid var(--border);
      display:flex;justify-content:space-between;align-items:center;
    }
    
    .template-modal-body{padding:20px;}
    
    .form-group{margin-bottom:16px;}
    .form-label{display:block;margin-bottom:6px;font-weight:500;font-size:14px}
    .form-input{
      width:100%;padding:10px;border:1px solid var(--border);
      border-radius:8px;font-size:14px;
    }
    .form-input:focus{border-color:var(--brand);outline:none}
    
    .tag{display:inline-flex;align-items:center;gap:4px;background:#f3f4f6;
      padding:4px 8px;border-radius:6px;font-size:12px;margin-right:6px;margin-bottom:6px;}
    
    .close-modal{background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)}
    
    /* Template actions */
    .template-actions{display:flex;gap:8px;margin-top:8px}
    .template-actions .btn.small{padding:6px 10px;font-size:12px}
    
    /* Search box */
    .search-box{
      width:100%;padding:10px 14px;border:1px solid var(--border);
      border-radius:8px;margin-bottom:12px;font-size:14px;
    }
    
    .empty-state{
      text-align:center;padding:40px 20px;color:var(--muted);
    }
    
    /* Settings modal */
    .settings-modal{
      display:none;position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.5);z-index:3000;align-items:center;justify-content:center;
      padding:20px;
    }
    
    .settings-modal-content{
      background:white;border-radius:14px;width:100%;max-width:500px;
      max-height:90vh;overflow-y:auto;
    }
    
    .settings-section{
      padding:20px;border-bottom:1px solid var(--border);
    }
    
    .settings-section:last-child{border-bottom:none;}
    
    /* PASTE HELPER POPUP */
    #pasteHelper{display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.2); z-index:2000; max-width:400px; width:90%;}
    #pasteHelper div{text-align:center;}
    #pasteHelper i{font-size:48px; color:#10b981; margin-bottom:15px;}
    #pasteHelper h3{margin:0 0 10px;}
    #pasteHelper p{color:#666; margin-bottom:20px; line-height:1.5;}
    #overlay{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1999;}
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="header">
        <div class="logo">PC</div>
        <div>
          <h1>Prompt Crafter Pro</h1>
          <div class="subtitle">Transform ideas into structured prompts · Created by Vijay Kumar</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn small settings" id="settingsBtn"><i class="fas fa-cog"></i> Settings</button>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="mainContent">
      <!-- TEMPLATE LIBRARY -->
      <div class="card">
        <div class="section-title">
          <div><i class="fas fa-layer-group"></i> Template Library</div>
          <div class="actions">
            <button class="btn small templates" id="newTemplateBtn"><i class="fas fa-plus"></i> New Template</button>
            <button class="btn small templates" id="toggleTemplatesBtn"><i class="fas fa-eye"></i> Show</button>
          </div>
        </div>
        
        <div id="templatesPanel" style="display:none">
          <input type="text" id="templateSearch" class="search-box" placeholder="Search templates...">
          
          <div class="template-categories" id="templateCategories">
            <!-- Categories will be populated by JS -->
          </div>
          
          <div class="templates-grid" id="templatesGrid">
            <!-- Templates will be populated by JS -->
          </div>
          
          <div id="emptyTemplates" class="empty-state" style="display:none">
            <i class="fas fa-inbox" style="font-size:48px;margin-bottom:12px;opacity:0.5"></i>
            <p>No templates found. Create your first template!</p>
          </div>
        </div>
      </div>

      <!-- QUICK EXAMPLES -->
      <div class="card">
        <div class="section-title"><i class="fas fa-bolt"></i> Quick Examples</div>
        <div class="examples" id="examplesContainer">
          <button class="example-btn" data-example="Write a professional email to my team about the deadline extension">Email</button>
          <button class="example-btn" data-example="Create a Python function to calculate Fibonacci sequence">Code</button>
          <button class="example-btn" data-example="Analyze the market trends for electric vehicles in 2024">Analysis</button>
          <button class="example-btn" data-example="Write a blog post about the benefits of meditation">Blog Post</button>
          <button class="example-btn" data-example="Design a workout plan for beginners">Workout Plan</button>
        </div>
      </div>

      <!-- INPUT CARD -->
      <div class="card">
        <div class="section-title"><i class="fas fa-edit"></i> Your Requirement
          <span id="convertedBadge" class="converted-badge" style="display:none">
            <i class="fas fa-check-circle"></i> Converted
          </span>
          <span id="timerDisplay" class="timer-display" style="display:none">
            <i class="fas fa-clock"></i> <span id="timerValue">60s</span>
          </span>
        </div>
        
        <div class="auto-convert">
          <input type="checkbox" id="autoConvert" checked>
          <label for="autoConvert">Auto-convert as I type (60s delay)</label>
        </div>
        
        <textarea id="requirement" placeholder="Type your requirement here..."></textarea>
        <button id="convertBtn" class="btn convert"><i class="fas fa-magic"></i> Convert to Prompt</button>
      </div>

      <!-- PRESET SELECTOR -->
      <div class="card">
        <div class="section-title"><i class="fas fa-sliders-h"></i> Prompt Style</div>
        <div class="preset-selector">
          <div class="preset-option active" data-preset="default">
            <i class="fas fa-check-circle"></i> Standard
          </div>
          <div class="preset-option" data-preset="claude">
            <i class="fas fa-robot"></i> Claude Optimized
          </div>
          <div class="preset-option" data-preset="chatgpt">
            <i class="fas fa-comment"></i> ChatGPT Optimized
          </div>
        </div>
      </div>

      <!-- OUTPUT CARD -->
      <div class="card">
        <div class="section-title"><i class="fas fa-code"></i> Generated Prompt</div>
        <textarea id="output" class="output" readonly placeholder="Your formatted prompt will appear here..."></textarea>
        
        <div class="stats">
          <span id="charCount">0 characters</span> • 
          <span id="wordCount">0 words</span> • 
          <span id="lineCount">0 lines</span>
        </div>

        <div style="height:12px"></div>
        <div class="row">
          <button class="btn small copy" id="copyBtn"><i class="fas fa-copy"></i> Copy</button>
          <div class="tooltip">
            <button class="btn small chatgpt" id="chatgptBtn"><i class="fas fa-paper-plane"></i> ChatGPT</button>
            <span class="tooltiptext">Opens ChatGPT with prompt ready to paste</span>
          </div>
          <div class="tooltip">
            <button class="btn small claude" id="claudeBtn"><i class="fas fa-paper-plane"></i> Claude</button>
            <span class="tooltiptext">Opens Claude with prompt ready to paste</span>
          </div>
          <div class="tooltip">
            <button class="btn small gemini" id="geminiBtn"><i class="fas fa-paper-plane"></i> Gemini</button>
            <span class="tooltiptext">Opens Gemini with prompt ready to paste</span>
          </div>
          <div class="tooltip">
            <button class="btn small perplexity" id="perplexityBtn"><i class="fas fa-paper-plane"></i> Perplexity</button>
            <span class="tooltiptext">Opens Perplexity with prompt ready to paste</span>
          </div>
          <div class="tooltip">
            <button class="btn small deepseek" id="deepseekBtn"><i class="fas fa-paper-plane"></i> DeepSeek</button>
            <span class="tooltiptext">Opens DeepSeek with prompt ready to paste</span>
          </div>
          <button class="btn small export" id="exportBtn"><i class="fas fa-download"></i> Export</button>
          <button class="btn small history" id="toggleHistoryBtn"><i class="fas fa-history"></i> History</button>
          <button class="btn small templates" id="saveAsTemplateBtn"><i class="fas fa-save"></i> Save as Template</button>
        </div>
        
        <div class="history-panel" id="historyPanel">
          <div style="font-size:13px;margin-bottom:8px;color:var(--muted)">Recent prompts (click to reuse):</div>
          <div id="historyList"></div>
        </div>
      </div>

      <!-- HOW TO USE -->
      <div class="card">
        <div class="section-title"><i class="fas fa-info-circle"></i> How to Use</div>
        <ol class="howto">
          <li><b>Browse templates</b> or type your requirement</li>
          <li><b>Auto-converts</b> after 60 seconds (or click Convert)</li>
          <li><b>Click any AI button</b> - prompt auto-copies and tool opens</li>
          <li><b>Save successful prompts</b> as templates for reuse</li>
        </ol>
        <div class="footer">
          Uses fine-tuned AI model for optimal prompts • v2.3 • <span id="usageCount">0 prompts generated</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-modal-content">
      <div class="settings-section">
        <h3 style="margin:0 0 15px"><i class="fas fa-cog"></i> Settings</h3>
        
        <div class="form-group">
          <label class="form-label">OpenAI API Key (Optional)</label>
          <div style="display:flex;gap:8px">
            <input type="password" id="settingsApiKey" class="form-input" placeholder="sk-...">
            <button class="btn small save" id="settingsSaveKeyBtn">Save</button>
          </div>
          <div class="muted">Your API key is stored locally and never sent to our servers.</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Auto-Convert Delay</label>
          <select id="autoConvertDelay" class="form-input">
            <option value="30">30 seconds</option>
            <option value="60" selected>60 seconds</option>
            <option value="120">2 minutes</option>
            <option value="300">5 minutes</option>
            <option value="0">Off</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Default Prompt Style</label>
          <select id="defaultPreset" class="form-input">
            <option value="default">Standard</option>
            <option value="claude">Claude Optimized</option>
            <option value="chatgpt">ChatGPT Optimized</option>
          </select>
        </div>
      </div>
      
      <div class="settings-section">
        <h4 style="margin:0 0 10px"><i class="fas fa-database"></i> Data Management</h4>
        
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn small" id="exportDataBtn" style="background:#10b981">
            <i class="fas fa-download"></i> Export All Data
          </button>
          <button class="btn small" id="importDataBtn" style="background:#f59e0b">
            <i class="fas fa-upload"></i> Import Data
          </button>
          <button class="btn small" id="clearDataBtn" style="background:#ef4444">
            <i class="fas fa-trash"></i> Clear Local Data
          </button>
        </div>
        
        <div class="muted" style="margin-top:10px">
          <p>Export your templates and prompts as a backup file.</p>
          <p>Warning: Clearing data cannot be undone.</p>
        </div>
      </div>
      
      <div style="padding:20px;text-align:right">
        <button class="btn" id="closeSettingsBtn" style="background:#6b7280">Close</button>
      </div>
    </div>
  </div>

  <!-- TEMPLATE MODAL -->
  <div class="template-modal" id="templateModal">
    <div class="template-modal-content">
      <div class="template-modal-header">
        <h3 style="margin:0" id="modalTitle">New Template</h3>
        <button class="close-modal" id="closeModalBtn">&times;</button>
      </div>
      <div class="template-modal-body">
        <div class="form-group">
          <label class="form-label">Template Name</label>
          <input type="text" id="templateName" class="form-input" placeholder="e.g., Professional Email Template">
        </div>
        
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea id="templateDescription" class="form-input" rows="3" placeholder="Describe what this template is for..."></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Prompt Content</label>
          <textarea id="templateContent" class="form-input" rows="6" placeholder="Paste your prompt template here..."></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Category</label>
          <select id="templateCategory" class="form-input">
            <option value="communication">Communication</option>
            <option value="coding">Coding</option>
            <option value="writing">Writing</option>
            <option value="analysis">Analysis</option>
            <option value="business">Business</option>
            <option value="creative">Creative</option>
            <option value="education">Education</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tags (comma separated)</label>
          <input type="text" id="templateTags" class="form-input" placeholder="email, professional, team">
          <div id="tagsPreview" style="margin-top:8px"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Example Usage</label>
          <textarea id="templateExample" class="form-input" rows="3" placeholder="Show how to use this template..."></textarea>
        </div>
        
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
          <button class="btn small" id="cancelTemplateBtn" style="background:#6b7280">Cancel</button>
          <button class="btn small" id="saveTemplateBtn" style="background:#4f46e5">Save Template</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NOTIFICATION -->
  <div class="notification" id="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notificationText">Copied to clipboard!</span>
  </div>

  <!-- PASTE HELPER POPUP -->
  <div id="pasteHelper" style="display:none;">
    <div>
      <i class="fas fa-clipboard-check"></i>
      <h3>Prompt Ready!</h3>
      <p>Your prompt has been copied to clipboard.</p>
      <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; text-align:left;">
        <div style="font-size:13px; color:#666; margin-bottom:5px;">Next steps:</div>
        <ol style="margin:0; padding-left:20px; font-size:14px;">
          <li>Go to the opened AI tool tab</li>
          <li>Click in the input box</li>
          <li>Press <strong>Ctrl+V</strong> (or Cmd+V on Mac)</li>
          <li>Press <strong>Enter</strong> to submit</li>
        </ol>
      </div>
      <div style="display:flex; gap:10px; justify-content:center;">
        <button id="closeHelper" style="padding:10px 20px; background:#4f46e5; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600;">Got it!</button>
        <button id="copyAgainBtn" style="padding:10px 20px; background:#f3f4f6; border:1px solid #e5e7eb; border-radius:8px; cursor:pointer;">Copy Again</button>
      </div>
    </div>
  </div>
  <div id="overlay"></div>

  <script>
    const OPENAI_API_URL = "https://api.openai.com/v1/chat/completions";
    const OPENAI_MODEL = "ft:gpt-3.5-turbo-1106:personal::CkAjxivm";
    
    // Global variables
    let currentPreset = 'default';
    let autoConvertEnabled = true;
    let autoConvertDelay = 60000; // 60 seconds
    let debounceTimer;
    let usageCount = 0;
    let lastConvertedText = '';
    let isConverted = false;
    let autoConvertTimer;
    let autoConvertCountdown = 60;
    let countdownInterval;
    let editingTemplateId = null;

    // Template categories with icons and colors
    const TEMPLATE_CATEGORIES = {
      'communication': { name: 'Communication', icon: 'fa-envelope', color: '#3b82f6' },
      'coding': { name: 'Coding', icon: 'fa-code', color: '#10b981' },
      'writing': { name: 'Writing', icon: 'fa-pen', color: '#8b5cf6' },
      'analysis': { name: 'Analysis', icon: 'fa-chart-bar', color: '#f59e0b' },
      'business': { name: 'Business', icon: 'fa-briefcase', color: '#ef4444' },
      'creative': { name: 'Creative', icon: 'fa-palette', color: '#ec4899' },
      'education': { name: 'Education', icon: 'fa-graduation-cap', color: '#06b6d4' },
      'other': { name: 'Other', icon: 'fa-th', color: '#6b7280' }
    };

    // Default templates
    const DEFAULT_TEMPLATES = [
      {
        id: '1',
        name: 'Professional Email',
        description: 'Write clear, professional emails for business communication',
        category: 'communication',
        tags: ['email', 'professional', 'business'],
        content: `# Role\nYou are an expert business communicator skilled in writing professional emails.\n\n# Objective\nWrite a professional email about [TOPIC] to [RECIPIENT]\n\n# Context\n- Recipient: [DESCRIBE RECIPIENT]\n- Relationship: [DESCRIBE RELATIONSHIP]\n- Purpose: [EMAIL PURPOSE]\n\n# Instructions\n1. Use professional but friendly tone\n2. Start with appropriate greeting\n3. State purpose clearly in first paragraph\n4. Provide necessary details\n5. Include clear call to action\n6. End with professional closing\n\n# Notes\n- Keep it concise (150-200 words)\n- Use proper email formatting\n- Include subject line\n- Check for tone appropriateness`,
        example: 'Write a professional email to my manager requesting a meeting to discuss project timeline adjustments.',
        usageCount: 0,
        createdAt: Date.now() - 86400000,
        isDefault: true
      }
    ];

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });

    // Initialize the app
    function initializeApp() {
      // Load saved data
      const savedKey = localStorage.getItem('OPENAI_API_KEY');
      if (savedKey) document.getElementById('apiKey')?.value = savedKey;
      
      // Load usage count
      const savedUsage = localStorage.getItem('promptCrafterUsage');
      if (savedUsage) {
        usageCount = parseInt(savedUsage);
        document.getElementById('usageCount').textContent = `${usageCount} prompts generated`;
      }
      
      // Load auto-convert delay
      const savedDelay = localStorage.getItem('autoConvertDelay') || '60';
      autoConvertDelay = parseInt(savedDelay) * 1000;
      autoConvertCountdown = parseInt(savedDelay);
      
      // Load default preset
      const savedPreset = localStorage.getItem('defaultPreset') || 'default';
      currentPreset = savedPreset;
      
      // Set active preset
      document.querySelectorAll('.preset-option').forEach(option => {
        option.classList.remove('active');
        if (option.dataset.preset === savedPreset) {
          option.classList.add('active');
        }
      });
      
      // Initialize templates
      initializeTemplates();
      
      // Set up event listeners
      setupEventListeners();
      
      // Show main content
      document.getElementById('mainContent').style.display = 'block';
      
      // Focus on requirement input
      setTimeout(() => {
        const requirementEl = document.getElementById('requirement');
        if (requirementEl) requirementEl.focus();
      }, 100);
    }

    // Initialize templates
    function initializeTemplates() {
      // Load templates from localStorage or use defaults
      let templates = JSON.parse(localStorage.getItem('promptTemplates') || '[]');
      
      // Add default templates if empty
      if (templates.length === 0) {
        templates = DEFAULT_TEMPLATES;
        localStorage.setItem('promptTemplates', JSON.stringify(templates));
      }
      
      // Populate categories
      populateCategories();
      
      // Render templates
      renderTemplates();
      
      // Set up template search
      document.getElementById('templateSearch')?.addEventListener('input', function(e) {
        filterTemplates(e.target.value);
      });
    }

    // Populate template categories
    function populateCategories() {
      const container = document.getElementById('templateCategories');
      if (!container) return;
      
      container.innerHTML = '';
      
      // Add "All" category
      const allBtn = document.createElement('div');
      allBtn.className = 'template-category active';
      allBtn.textContent = 'All';
      allBtn.dataset.category = 'all';
      allBtn.addEventListener('click', function() {
        document.querySelectorAll('.template-category').forEach(cat => cat.classList.remove('active'));
        this.classList.add('active');
        renderTemplates();
      });
      container.appendChild(allBtn);
      
      // Add other categories
      Object.keys(TEMPLATE_CATEGORIES).forEach(categoryId => {
        const category = TEMPLATE_CATEGORIES[categoryId];
        const btn = document.createElement('div');
        btn.className = 'template-category';
        btn.textContent = category.name;
        btn.dataset.category = categoryId;
        btn.addEventListener('click', function() {
          document.querySelectorAll('.template-category').forEach(cat => cat.classList.remove('active'));
          this.classList.add('active');
          renderTemplates(categoryId);
        });
        container.appendChild(btn);
      });
    }

    // Render templates
    function renderTemplates(category = 'all') {
      const container = document.getElementById('templatesGrid');
      const emptyState = document.getElementById('emptyTemplates');
      if (!container) return;
      
      let templates = JSON.parse(localStorage.getItem('promptTemplates') || '[]');
      
      // Filter by category if not "all"
      if (category !== 'all') {
        templates = templates.filter(t => t.category === category);
      }
      
      // Apply search filter if active
      const searchTerm = document.getElementById('templateSearch')?.value.toLowerCase() || '';
      if (searchTerm) {
        templates = templates.filter(t => 
          t.name.toLowerCase().includes(searchTerm) ||
          t.description.toLowerCase().includes(searchTerm) ||
          t.tags?.some(tag => tag.toLowerCase().includes(searchTerm)) ||
          t.category.toLowerCase().includes(searchTerm)
        );
      }
      
      if (templates.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }
      
      container.style.display = 'grid';
      emptyState.style.display = 'none';
      
      container.innerHTML = '';
      
      templates.forEach(template => {
        const categoryInfo = TEMPLATE_CATEGORIES[template.category] || TEMPLATE_CATEGORIES.other;
        
        const card = document.createElement('div');
        card.className = 'template-card';
        card.innerHTML = `
          <div class="template-icon" style="background:${categoryInfo.color}">
            <i class="fas ${categoryInfo.icon}"></i>
          </div>
          <div class="template-title">${template.name}</div>
          <div class="template-desc">${template.description}</div>
          <div class="template-meta">
            <span>${categoryInfo.name}</span>
            <span>${template.usageCount || 0} uses</span>
          </div>
          <div class="template-actions">
            <button class="btn small use-template" data-id="${template.id}" style="background:#4f46e5">
              <i class="fas fa-play"></i> Use
            </button>
            <button class="btn small edit-template" data-id="${template.id}" style="background:#6b7280">
              <i class="fas fa-edit"></i> Edit
            </button>
            ${template.isDefault ? '' : `<button class="btn small delete-template" data-id="${template.id}" style="background:#ef4444">
              <i class="fas fa-trash"></i> Delete
            </button>`}
          </div>
        `;
        
        container.appendChild(card);
      });
      
      // Add event listeners for template actions
      document.querySelectorAll('.use-template').forEach(btn => {
        btn.addEventListener('click', function() {
          const templateId = this.dataset.id;
          useTemplate(templateId);
        });
      });
      
      document.querySelectorAll('.edit-template').forEach(btn => {
        btn.addEventListener('click', function() {
          const templateId = this.dataset.id;
          editTemplate(templateId);
        });
      });
      
      document.querySelectorAll('.delete-template').forEach(btn => {
        btn.addEventListener('click', function() {
          const templateId = this.dataset.id;
          deleteTemplate(templateId);
        });
      });
    }

    // Filter templates
    function filterTemplates(searchTerm) {
      renderTemplates(document.querySelector('.template-category.active')?.dataset.category || 'all');
    }

    // Use template
    function useTemplate(templateId) {
      const templates = JSON.parse(localStorage.getItem('promptTemplates') || '[]');
      const template = templates.find(t => t.id === templateId);
      
      if (template) {
        // Update usage count
        template.usageCount = (template.usageCount || 0) + 1;
        localStorage.setItem('promptTemplates', JSON.stringify(templates));
        
        // Load template into requirement field
        document.getElementById('requirement').value = template.example || template.content;
        
        // Trigger conversion
        generatePrompt();
        
        // Show notification
        showNotification(`Using template: ${template.name}`);
      }
    }

    // Edit template
    function editTemplate(templateId) {
      const templates = JSON.parse(localStorage.getItem('promptTemplates') || '[]');
      const template = templates.find(t => t.id === templateId);
      
      if (template && !template.isDefault) {
        editingTemplateId = templateId;
        
        document.getElementById('modalTitle').textContent = 'Edit Template';
        document.getElementById('templateName').value = template.name;
        document.getElementById('templateDescription').value = template.description;
        document.getElementById('templateContent').value = template.content;
        document.getElementById('templateCategory').value = template.category;
        document.getElementById('templateTags').value = template.tags?.join(', ') || '';
        document.getElementById('templateExample').value = template.example || '';
        
        document.getElementById('templateModal').style.display = 'flex';
      }
    }

    // Delete template
    function deleteTemplate(templateId) {
      if (confirm('Are you sure you want to delete this template?')) {
        let templates = JSON.parse(localStorage.getItem('promptTemplates') || '[]');
        templates = templates.filter(t => t.id !== templateId);
        localStorage.setItem('promptTemplates', JSON.stringify(templates));
        
        renderTemplates();
        showNotification('Template deleted');
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Example buttons - FIXED VERSION
      document.getElementById('examplesContainer').addEventListener('click', function(e) {
        if (e.target.classList.contains('example-btn')) {
          const exampleText = e.target.getAttribute('data-example');
          
          // Clear any existing auto-convert timer
          if (countdownInterval) {
            clearInterval(countdownInterval);
            document.getElementById('timerDisplay').style.display = 'none';
          }
          
          // Set the requirement
          document.getElementById('requirement').value = exampleText;
          
          // Highlight the clicked button briefly
          e.target.style.transform = 'scale(0.98)';
          e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
          setTimeout(() => {
            e.target.style.transform = '';
            e.target.style.boxShadow = '';
          }, 200);
          
          // Show notification
          showNotification(`Loading "${e.target.textContent}" example...`);
          
          // Generate prompt after a short delay
          setTimeout(() => {
            generatePrompt();
          }, 500);
        }
      });

      // Preset selector
      document.querySelectorAll('.preset-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.preset-option').forEach(opt => opt.classList.remove('active'));
          this.classList.add('active');
          currentPreset = this.dataset.preset;
          
          // Regenerate prompt if there's content
          if (document.getElementById('requirement').value.trim()) {
            generatePrompt();
          }
        });
      });

      // Convert button
      document.getElementById('convertBtn').addEventListener('click', generatePrompt);

      // Auto-convert checkbox
      document.getElementById('autoConvert').addEventListener('change', function() {
        autoConvertEnabled = this.checked;
        if (!autoConvertEnabled && countdownInterval) {
          clearInterval(countdownInterval);
          document.getElementById('timerDisplay').style.display = 'none';
        }
      });

      // Requirement textarea
      const requirementEl = document.getElementById('requirement');
      requirementEl.addEventListener('input', function() {
        updateStats();
        
        if (autoConvertEnabled && this.value.trim()) {
          startAutoConvertTimer();
        } else if (countdownInterval) {
          clearInterval(countdownInterval);
          document.getElementById('timerDisplay').style.display = 'none';
        }
      });

      // Copy button
      document.getElementById('copyBtn').addEventListener('click', copyToClipboard);

      // AI platform buttons
      document.getElementById('chatgptBtn').addEventListener('click', () => openAIWithPrompt('chatgpt'));
      document.getElementById('claudeBtn').addEventListener('click', () => openAIWithPrompt('claude'));
      document.getElementById('geminiBtn').addEventListener('click', () => openAIWithPrompt('gemini'));
      document.getElementById('perplexityBtn').addEventListener('click', () => openAIWithPrompt('perplexity'));
      document.getElementById('deepseekBtn').addEventListener('click', () => openAIWithPrompt('deepseek'));

      // Export button
      document.getElementById('exportBtn').addEventListener('click', exportPrompt);

      // History button
      document.getElementById('toggleHistoryBtn').addEventListener('click', toggleHistory);

      // Save as template button
      document.getElementById('saveAsTemplateBtn').addEventListener('click', saveAsTemplate);

      // Toggle templates button
      document.getElementById('toggleTemplatesBtn').addEventListener('click', function() {
        const panel = document.getElementById('templatesPanel');
        const icon = this.querySelector('i');
        
        if (panel.style.display === 'none') {
          panel.style.display = 'block';
          icon.className = 'fas fa-eye-slash';
          this.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
        } else {
          panel.style.display = 'none';
          icon.className = 'fas fa-eye';
          this.innerHTML = '<i class="fas fa-eye"></i> Show';
        }
      });

      // New template button
      document.getElementById('newTemplateBtn').addEventListener('click', function() {
        editingTemplateId = null;
        document.getElementById('modalTitle').textContent = 'New Template';
        document.getElementById('templateName').value = '';
        document.getElementById('templateDescription').value = '';
        document.getElementById('templateContent').value = '';
        document.getElementById('templateCategory').value = 'communication';
        document.getElementById('templateTags').value = '';
        document.getElementById('templateExample').value = '';
        document.getElementById('templateModal').style.display = 'flex';
      });

      // Template modal buttons
      document.getElementById('closeModalBtn').addEventListener('click', closeTemplateModal);
      document.getElementById('cancelTemplateBtn').addEventListener('click', closeTemplateModal);
      document.getElementById('saveTemplateBtn').addEventListener('click', saveTemplate);

      // Template tags input
      document.getElementById('templateTags')?.addEventListener('input', updateTagsPreview);

      // Settings
      document.getElementById('settingsBtn').addEventListener('click', function() {
        document.getElementById('settingsModal').style.display = 'flex';
        loadSettings();
      });

      document.getElementById('closeSettingsBtn').addEventListener('click', function() {
        document.getElementById('settingsModal').style.display = 'none';
      });

      document.getElementById('settingsSaveKeyBtn').addEventListener('click', function() {
        const apiKey = document.getElementById('settingsApiKey').value.trim();
        localStorage.setItem('OPENAI_API_KEY', apiKey);
        showNotification('API key saved');
      });

      document.getElementById('autoConvertDelay').addEventListener('change', function() {
        const delay = parseInt(this.value);
        localStorage.setItem('autoConvertDelay', delay);
        autoConvertDelay = delay * 1000;
        autoConvertCountdown = delay;
        showNotification(`Auto-convert delay set to ${delay} seconds`);
      });

      document.getElementById('defaultPreset').addEventListener('change', function() {
        localStorage.setItem('defaultPreset', this.value);
        showNotification(`Default preset set to ${this.value}`);
      });

      // Data management
      document.getElementById('exportDataBtn').addEventListener('click', exportAllData);
      document.getElementById('importDataBtn').addEventListener('click', importData);
      document.getElementById('clearDataBtn').addEventListener('click', clearData);

      // Paste helper
      document.getElementById('closeHelper').addEventListener('click', closePasteHelper);
      document.getElementById('copyAgainBtn').addEventListener('click', copyToClipboard);

      // Close modals when clicking outside
      window.addEventListener('click', function(event) {
        const templateModal = document.getElementById('templateModal');
        const settingsModal = document.getElementById('settingsModal');
        
        if (event.target === templateModal) {
          closeTemplateModal();
        }
        if (event.target === settingsModal) {
          document.getElementById('settingsModal').style.display = 'none';
        }
      });
    }

    // Generate prompt
    async function generatePrompt() {
      const requirement = document.getElementById('requirement').value.trim();
      if (!requirement) {
        showNotification('Please enter a requirement first');
        return;
      }

      const convertBtn = document.getElementById('convertBtn');
      const originalText = convertBtn.innerHTML;
      convertBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Converting...';
      convertBtn.disabled = true;

      try {
        let prompt = '';
        
        // Check if we have an API key
        const apiKey = localStorage.getItem('OPENAI_API_KEY');
        
        if (apiKey && apiKey.startsWith('sk-')) {
          // Use OpenAI API
          prompt = await generateWithOpenAI(requirement);
        } else {
          // Use local template-based generation
          prompt = generateLocally(requirement);
        }

        // Update output
        document.getElementById('output').value = prompt;
        updateStats();
        
        // Update history
        addToHistory(requirement, prompt);
        
        // Update usage count
        usageCount++;
        localStorage.setItem('promptCrafterUsage', usageCount.toString());
        document.getElementById('usageCount').textContent = `${usageCount} prompts generated`;
        
        // Show converted badge
        document.getElementById('convertedBadge').style.display = 'inline-flex';
        isConverted = true;
        lastConvertedText = requirement;
        
        showNotification('Prompt generated successfully!');
        
      } catch (error) {
        console.error('Error generating prompt:', error);
        document.getElementById('output').value = `# Error generating prompt\n\n${error.message || 'Please check your API key or try again.'}\n\n# Manual Template:\n\nRole: AI Assistant\nTask: ${requirement}\n\nInstructions:\n1. Understand the user's requirement\n2. Break it down into clear steps\n3. Provide detailed guidance\n4. Include examples if relevant`;
        showNotification('Using fallback template. Add OpenAI API key for better results.');
      } finally {
        convertBtn.innerHTML = originalText;
        convertBtn.disabled = false;
        
        // Reset auto-convert timer
        if (autoConvertEnabled) {
          startAutoConvertTimer();
        }
      }
    }

    // Generate with OpenAI
    async function generateWithOpenAI(requirement) {
      const apiKey = localStorage.getItem('OPENAI_API_KEY');
      if (!apiKey) throw new Error('No API key found');

      const preset = getPresetConfig(currentPreset);
      
      const response = await fetch(OPENAI_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: OPENAI_MODEL,
          messages: [
            {
              role: "system",
              content: preset.systemPrompt
            },
            {
              role: "user",
              content: requirement
            }
          ],
          temperature: preset.temperature,
          max_tokens: 2000
        })
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    // Generate locally
    function generateLocally(requirement) {
      const preset = getPresetConfig(currentPreset);
      
      // Simple template-based generation
      return `${preset.templateHeader}

# User Requirement
${requirement}

# Structured Prompt
${preset.structureTemplate.replace('[REQUIREMENT]', requirement)}

# Additional Notes
- Be specific and detailed in your response
- Use clear, professional language
- Break down complex tasks into steps
- Include examples when helpful`;
    }

    // Get preset configuration
    function getPresetConfig(presetName) {
      const presets = {
        'default': {
          systemPrompt: "You are a prompt engineering expert. Convert user requirements into well-structured, detailed prompts for AI systems.",
          templateHeader: "# AI Prompt Template\n\n## Role Definition",
          structureTemplate: "1. **Role**: Expert AI assistant\n2. **Task**: [REQUIREMENT]\n3. **Context**: Provide necessary background\n4. **Instructions**: Step-by-step guidance\n5. **Constraints**: Any limitations or requirements\n6. **Output Format**: Desired response structure",
          temperature: 0.7
        },
        'claude': {
          systemPrompt: "You are a prompt engineer specializing in Claude AI. Create prompts optimized for Claude's capabilities.",
          templateHeader: "# Claude-Optimized Prompt\n\n## Assistant Configuration",
          structureTemplate: "1. **Role**: Claude AI expert\n2. **Objective**: [REQUIREMENT]\n3. **Thinking Process**: Show your reasoning\n4. **Response Style**: Conversational but precise\n5. **Format Requirements**: Use markdown appropriately\n6. **Claude-specific**: Leverage long context and reasoning",
          temperature: 0.8
        },
        'chatgpt': {
          systemPrompt: "You are a ChatGPT prompt specialist. Create effective prompts for ChatGPT with clear instructions.",
          templateHeader: "# ChatGPT Prompt Template\n\n## System Message",
          structureTemplate: "1. **Role**: ChatGPT specialist\n2. **Goal**: [REQUIREMENT]\n3. **Step-by-step**: Break down the task\n4. **Tone**: Professional and helpful\n5. **Examples**: Include if relevant\n6. **Constraints**: Stay within capabilities",
          temperature: 0.7
        }
      };
      
      return presets[presetName] || presets.default;
    }

    // Update stats
    function updateStats() {
      const text = document.getElementById('output').value;
      const charCount = text.length;
      const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      const lineCount = text === '' ? 0 : text.split('\n').length;
      
      document.getElementById('charCount').textContent = `${charCount} characters`;
      document.getElementById('wordCount').textContent = `${wordCount} words`;
      document.getElementById('lineCount').textContent = `${lineCount} lines`;
    }

    // Start auto-convert timer
    function startAutoConvertTimer() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
      
      autoConvertCountdown = autoConvertDelay / 1000;
      document.getElementById('timerDisplay').style.display = 'inline-flex';
      document.getElementById('timerValue').textContent = `${autoConvertCountdown}s`;
      
      countdownInterval = setInterval(() => {
        autoConvertCountdown--;
        document.getElementById('timerValue').textContent = `${autoConvertCountdown}s`;
        
        if (autoConvertCountdown <= 0) {
          clearInterval(countdownInterval);
          document.getElementById('timerDisplay').style.display = 'none';
          
          const currentText = document.getElementById('requirement').value.trim();
          if (currentText && currentText !== lastConvertedText) {
            generatePrompt();
          }
        }
      }, 1000);
    }

    // Copy to clipboard
    function copyToClipboard() {
      const output = document.getElementById('output');
      if (!output.value.trim()) {
        showNotification('Nothing to copy');
        return;
      }
      
      navigator.clipboard.writeText(output.value).then(() => {
        showNotification('Copied to clipboard!');
        closePasteHelper();
      }).catch(err => {
        console.error('Copy failed:', err);
        showNotification('Copy failed. Please select and copy manually.');
      });
    }

    // Open AI with prompt
    function openAIWithPrompt(platform) {
      const output = document.getElementById('output');
      if (!output.value.trim()) {
        showNotification('Generate a prompt first');
        return;
      }
      
      // Copy to clipboard
      navigator.clipboard.writeText(output.value).then(() => {
        // Open the AI platform
        const urls = {
          chatgpt: 'https://chat.openai.com',
          claude: 'https://claude.ai',
          gemini: 'https://gemini.google.com',
          perplexity: 'https://www.perplexity.ai',
          deepseek: 'https://chat.deepseek.com'
        };
        
        window.open(urls[platform], '_blank');
        
        // Show paste helper
        document.getElementById('pasteHelper').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
      });
    }

    // Close paste helper
    function closePasteHelper() {
      document.getElementById('pasteHelper').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    // Export prompt
    function exportPrompt() {
      const prompt = document.getElementById('output').value;
      if (!prompt.trim()) {
        showNotification('Nothing to export');
        return;
      }
      
      const blob = new Blob([prompt], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `prompt-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification('Prompt exported as text file');
    }

    // Toggle history panel
    function toggleHistory() {
      const panel = document.getElementById('historyPanel');
      const btn = document.getElementById('toggleHistoryBtn');
      
      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-history"></i> Hide History';
        loadHistory();
      } else {
        panel.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-history"></i> History';
      }
    }

    // Load history
    function loadHistory() {
      const history = JSON.parse(localStorage.getItem('promptHistory') || '[]');
      const container = document.getElementById('historyList');
      
      container.innerHTML = '';
      
      if (history.length === 0) {
        container.innerHTML = '<div style="color:var(--muted);font-style:italic;padding:10px;text-align:center;">No history yet</div>';
        return;
      }
      
      // Show last 10 items
      history.slice(-10).reverse().forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        
        const truncatedText = item.input.length > 60 ? item.input.substring(0, 60) + '...' : item.input;
        const date = new Date(item.timestamp).toLocaleDateString();
        
        div.innerHTML = `
          <div>
            <strong>${truncatedText}</strong>
            <div style="font-size:11px;color:var(--muted)">${date}</div>
          </div>
          <button class="btn small" style="background:#4f46e5;padding:4px 8px;font-size:11px;" data-index="${history.length - 1 - index}">Use</button>
        `;
        
        container.appendChild(div);
      });
      
      // Add event listeners to use buttons
      container.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          const history = JSON.parse(localStorage.getItem('promptHistory') || '[]');
          const item = history[index];
          
          if (item) {
            document.getElementById('requirement').value = item.input;
            document.getElementById('output').value = item.output;
            updateStats();
            showNotification('Prompt loaded from history');
          }
        });
      });
    }

    // Add to history
    function addToHistory(input, output) {
      let history = JSON.parse(localStorage.getItem('promptHistory') || '[]');
      
      history.push({
        input,
        output,
        timestamp: Date.now(),
        preset: currentPreset
      });
      
      // Keep only last 50 items
      if (history.length > 50) {
        history = history.slice(-50);
      }
      
      localStorage.setItem('promptHistory', JSON.stringify(history));
      
      // Refresh history display if visible
      if (document.getElementById('historyPanel').style.display === 'block') {
        loadHistory();
      }
    }

    // Save as template
    function saveAsTemplate() {
      const output = document.getElementById('output').value.trim();
      const requirement = document.getElementById('requirement').value.trim();
      
      if (!output || !requirement) {
        showNotification('Generate a prompt first');
        return;
      }
      
      editingTemplateId = null;
      document.getElementById('modalTitle').textContent = 'Save as Template';
      document.getElementById('templateName').value = requirement.substring(0, 50) + (requirement.length > 50 ? '...' : '');
      document.getElementById('templateDescription').value = `Generated from: ${requirement.substring(0, 100)}...`;
      document.getElementById('templateContent').value = output;
      document.getElementById('templateCategory').value = 'other';
      document.getElementById('templateTags').value = 'generated';
      document.getElementById('templateExample').value = requirement;
      document.getElementById('templateModal').style.display = 'flex';
    }

    // Close template modal
    function closeTemplateModal() {
      document.getElementById('templateModal').style.display = 'none';
      editingTemplateId = null;
    }

    // Update tags preview
    function updateTagsPreview() {
      const tagsInput = document.getElementById('templateTags').value;
      const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
      const container = document.getElementById('tagsPreview');
      
      container.innerHTML = tags.map(tag => 
        `<span class="tag"><i class="fas fa-tag"></i> ${tag}</span>`
      ).join('');
    }

    // Save template
    function saveTemplate() {
      const name = document.getElementById('templateName').value.trim();
      const description = document.getElementById('templateDescription').value.trim();
      const content = document.getElementById('templateContent').value.trim();
      const category = document.getElementById('templateCategory').value;
      const tags = document.getElementById('templateTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
      const example = document.getElementById('templateExample').value.trim();
      
      if (!name || !content) {
        showNotification('Name and content are required');
        return;
      }
      
      let templates = JSON.parse(localStorage.getItem('promptTemplates') || '[]');
      
      if (editingTemplateId) {
        // Update existing template
        const index = templates.findIndex(t => t.id === editingTemplateId);
        if (index !== -1) {
          templates[index] = {
            ...templates[index],
            name,
            description,
            content,
            category,
            tags,
            example,
            updatedAt: Date.now()
          };
        }
      } else {
        // Add new template
        const newTemplate = {
          id: Date.now().toString(),
          name,
          description,
          content,
          category,
          tags,
          example,
          usageCount: 0,
          createdAt: Date.now(),
          isDefault: false
        };
        
        templates.push(newTemplate);
      }
      
      localStorage.setItem('promptTemplates', JSON.stringify(templates));
      closeTemplateModal();
      renderTemplates();
      showNotification(editingTemplateId ? 'Template updated' : 'Template saved');
    }

    // Load settings
    function loadSettings() {
      const savedDelay = localStorage.getItem('autoConvertDelay') || '60';
      const savedPreset = localStorage.getItem('defaultPreset') || 'default';
      const savedApiKey = localStorage.getItem('OPENAI_API_KEY') || '';
      
      document.getElementById('autoConvertDelay').value = savedDelay;
      document.getElementById('defaultPreset').value = savedPreset;
      document.getElementById('settingsApiKey').value = savedApiKey;
    }

    // Export all data
    function exportAllData() {
      const data = {
        templates: JSON.parse(localStorage.getItem('promptTemplates') || '[]'),
        history: JSON.parse(localStorage.getItem('promptHistory') || '[]'),
        settings: {
          apiKey: localStorage.getItem('OPENAI_API_KEY'),
          usageCount: localStorage.getItem('promptCrafterUsage'),
          autoConvertDelay: localStorage.getItem('autoConvertDelay'),
          defaultPreset: localStorage.getItem('defaultPreset')
        },
        exportedAt: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `prompt-crafter-backup-${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification('Data exported successfully');
    }

    // Import data
    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(event) {
          try {
            const data = JSON.parse(event.target.result);
            
            if (data.templates) {
              localStorage.setItem('promptTemplates', JSON.stringify(data.templates));
            }
            
            if (data.history) {
              localStorage.setItem('promptHistory', JSON.stringify(data.history));
            }
            
            if (data.settings) {
              if (data.settings.apiKey) {
                localStorage.setItem('OPENAI_API_KEY', data.settings.apiKey);
              }
              if (data.settings.usageCount) {
                localStorage.setItem('promptCrafterUsage', data.settings.usageCount);
              }
              if (data.settings.autoConvertDelay) {
                localStorage.setItem('autoConvertDelay', data.settings.autoConvertDelay);
              }
              if (data.settings.defaultPreset) {
                localStorage.setItem('defaultPreset', data.settings.defaultPreset);
              }
            }
            
            showNotification('Data imported successfully');
            setTimeout(() => location.reload(), 1000);
          } catch (error) {
            showNotification('Error importing data: Invalid file format');
          }
        };
        
        reader.readAsText(file);
      };
      
      input.click();
    }

    // Clear data
    function clearData() {
      if (confirm('This will clear all local data (templates, history, settings). Continue?')) {
        localStorage.clear();
        showNotification('All local data cleared');
        setTimeout(() => location.reload(), 1000);
      }
    }

    // Show notification
    function showNotification(message) {
      const notification = document.getElementById('notification');
      document.getElementById('notificationText').textContent = message;
      notification.style.display = 'flex';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>
